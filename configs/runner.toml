# =============================================================================
# DeepGiBox Runner Configuration (Universal)
# =============================================================================
# Single config file for all endoscope types
# Press keys 1, 2 during runtime to switch between:
#   1 = Fuji
#   2 = Olympus
# =============================================================================

# Pipeline mode: "hardware_keying", "inference_only", or "visualization"
mode = "hardware_keying"

[general]
test_duration_seconds = 0          # 0 = run indefinitely
enable_debug_dumps = false
debug_dump_frame_count = 5
stats_print_interval = 60          # Print stats every N frames
enable_runtime_statistics = true   # Show statistics during runtime (every N frames)
enable_final_summary = true        # Show final summary when program ends

# =============================================================================
# Video Capture Configuration
# =============================================================================
[capture]
device_index = 0                   # DeckLink device index
expected_resolution = "2160p30"    # 1080p60, 2160p60, etc.

# =============================================================================
# Preprocessing Configuration
# =============================================================================
[preprocessing]
output_width = 512                 # Model input width (must match engine)
output_height = 512                # Model input height (must match engine)
use_fp16 = false                   # Use FP16 for preprocessing (must match engine!)
cuda_device = 0                    # CUDA device index
mean = [0.0, 0.0, 0.0]            # Normalization mean
std = [1.0, 1.0, 1.0]             # Normalization std
chroma_order = "UYVY"              # UYVY or YUY2


# Initial endoscope mode (can be changed with keys 1, 2)
initial_endoscope_mode = "olympus"  # "fuji" or "olympus"

# =============================================================================
# Inference Configuration
# =============================================================================
[inference]
engine_path = "configs/model/v7_optimized_YOLOv5.engine"
lib_path = "trt-shim/build/libtrt_shim.so"

# =============================================================================
# Postprocessing Configuration
# =============================================================================
[postprocessing]
num_classes = 2
confidence_threshold = 0.25
nms_threshold = 0.52
max_detections = 120
verbose_stats = false

[postprocessing.temporal_smoothing]
enable = true
window_size = 4                    # **ลดลง** (จาก 10) เพื่อให้ค่า Conf ตอบสนองไวขึ้น ไม่รอเฉลี่ยนาน

[postprocessing.tracking]
enable = true
max_age = 45                       # ปรับให้พอดีๆ ไม่ต้องค้างนานเกินไปจนเป็น Ghost
min_confidence = 0.25
iou_threshold = 0.30               # ขยับขึ้นนิดนึง ต้องการความแม่นยำในการจับคู่ระยะใกล้

[postprocessing.tracking.motion]
use_kalman = true
kalman_process_noise = 1.5         # **เพิ่มขึ้นมาก** (High Agility) บอกระบบว่าวัตถุเราเปลี่ยนทิศทางไวมาก อย่าดื้อ
kalman_measurement_noise = 0.1     # **ลดลงต่ำสุดๆ** (Trust Observation) บอกให้เชื่อ "สิ่งที่ตาเห็น" (Detection) มากกว่า "การคำนวณล่วงหน้า"
use_optical_flow = true
optical_flow_alpha = 0.5           # เพิ่มความไวต่อ Optical flow
optical_flow_max_pixels = 25.0     # ยอมให้ขยับได้ระยะไกลขึ้นต่อเฟรม
use_velocity = true
velocity_alpha = 0.6               # ปรับให้ velocity เปลี่ยนค่าไวขึ้น
velocity_max_delta = 30.0
velocity_decay = 0.4               # **เพิ่มขึ้น** ให้แรงส่งเก่าหายไปไวๆ จะได้เปลี่ยนทิศทางทันที (เลี้ยวคม)

[postprocessing.ema_smoothing]
enable = true
alpha_position = 0.75              # **พระเอกของความจิก** ค่านี้ยิ่งใกล้ 1.0 ยิ่งพุ่งเข้าหาเป้าไว (แนะนำ 0.7-0.8 สำหรับความจิก)
alpha_size = 0.60                  # ให้ขนาดกล่องขยาย/หด ไวขึ้นตามวัตถุจริง

# =============================================================================
# Overlay Configuration
# =============================================================================
[overlay]
enable_full_ui = true
# Display mode: "colon" or "egd" (text shown on UI overlay)
display_mode = "egd"
# Show speaker icon in top-right corner
show_speaker = true

[overlay.bbox]
base_thickness = 4                 # Base thickness for bounding box
corner_length_factor = 0.15        # Corner length as factor of box size
corner_min_length = 30.0           # Minimum corner length in pixels
corner_max_length = 80.0           # Maximum corner length in pixels
corner_thickness = 6               # Corner line thickness

[overlay.label]
font_size = 24                     # Font size for labels
show_confidence = true             # Show confidence score
show_track_id = true               # Show tracking ID
label_offset_y = -15.0             # Label offset from bbox top

# =============================================================================
# Rendering Configuration
# =============================================================================
[rendering]
text_antialiasing = true
# Enable debug rendering messages (prints [DEBUG] overlay operation details)
debug_rendering = false

# =============================================================================
# Keying Configuration
# =============================================================================
[keying]
keyer_level = 255                  # Keyer level (0-255)
enable_internal_keying = true      # Enable DeckLink internal keying

# =============================================================================
# Performance Configuration
# =============================================================================
[performance]
gpu_buffer_pool_size = 10
gpu_buffer_reuse = true
print_detailed_timings = true
print_per_frame_latency = true

# =============================================================================
# Class Configuration
# =============================================================================
[classes]
labels = ["polyp", "other"]
